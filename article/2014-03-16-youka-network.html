<!doctype html>
<html>
<head>

<title>
本の虫: 妖怪ネットワークにRTX810を導入した 
</title>


<link rel="stylesheet" type="text/css" href="../css/default.css" ></link>

<style type="text/css">
</style>

<!-- highlight.js -->
<link rel="stylesheet" type="text/css" href="../css/github.css"></link>
<script type="text/javascript" src="../js/highlight.pack.js"></script>
<script type="text/javascript">hljs.initHighlightingOnLoad();</script>

<!-- mathjax CDN -->
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


</head>

<body>

<header>
<h1><a href="http://cpplover.blogspot.jp/">本の虫</a></h1>

<p>
著者：江添亮<br>
ブログ: <a href="http://cpplover.blogspot.jp/">http://cpplover.blogspot.jp/</a><br>
メール: boostcpp@gmail.com<br>
Twitter: <a href="https://twitter.com/EzoeRyou">https://twitter.com/EzoeRyou</a><br>
GitHub: <a href="https://github.com/EzoeRyou">https://github.com/EzoeRyou</a>
</p>
<p>
<a href="http://www.amazon.co.jp/registry/wishlist/1X43J4K0NJVHK">アマゾンの江添のほしい物リスト</a>を著者に送るとブログ記事のネタになる
</p>

<p>
筆者にブログのネタになる品物を直接送りたい場合の宛先：<br>
郵便番号：165-0027<br>
住所：東京都中野区野方5-30-13 ヴィラアテネ401<br>
宛名：江添亮
</p>
</header>


<article>
<h1><a href="http://cpplover.blogspot.jp/2014/03/rtx810.html">妖怪ネットワークにRTX810を導入した</a></h1>


<p>
筆者の住んでいるシェアハウスである妖怪ハウスのネットワーク環境、すなわち妖怪ネットワークの構築が、一段落した。ついに、YAMAYAのRTX810を導入することに成功したのだ。
</p>

<p>
RTX810の初期設定は、一般家庭で使うにはかなり変わっているので、結構な設定が必要だった。
</p>

<p>
まず、初期設定では誰でもログインできるようになっているので、適切にパスワードを設定した。
</p>

<p>
デフォルトで設定されるファイヤーウォールが不思議だ。まだRTX810独自のコマンドを読むのに慣れていないのだが、どうもデフォルトで設定されるフィルターは、プライベートIPアドレス間での通信、つまりプレイベートネットワーク内のホスト同士での通信を完全に遮断しているように読める。実際に、RTX810を介して無線LAN APにログインできないので、正しいのではないかと思う。
</p>

<p>
さらに、ファイル共有で使われるSMBプロトコルも遮断しているように読める。
</p>

<p>
無線LAN APへのログインは滅多に行わないし、行う場合は無線LAN APについているLANポートと有線接続すればいい。しかし、SMBは妖怪ネットワークの住人の間でも多用されているので、これはまずい。このフィルターは削除した。
</p>

<p>
また、この調査の過程で、妖怪ネットワーク内で、重要な機密性のあるファイルが存在するディレクトリを、意図せずにパスワード無しでSMBプロトコルで公開してしまっている住人を発見したので、注意して直させた。
</p>

<p>
RTX810を妖怪ハウスに導入するにあたっての問題は、その接続方法であった。
</p>

<p>
妖怪ハウスネットワークとインターネットを接続するのは、フレッツ光で、ISPからレンタルしているPR-400MIというモデム兼ルーターを使わなければならない。妖怪ネットワークのパフォーマンスの低さは、まともなスイッチングハブを導入することでかなり改善されたのだが、せっかく強力なルーターであるYAMAHAのRTX810があるので、これを活用してみたいところだ。しかし、どうやってRTX810を直接つなげればいいのだろうか。
</p>

<p>
まず考えられるのは、PR-400MIにRTX810をつなげて、PR-400MIのDHCPを無効にし、プレイベートネットワークはRTX810で引き受けることである。PR-400MIにはPPPoEブリッジ機能もあるので、RTX810は、PR-400MI経由とはいえど、直接PPPoEを話すことができる。これは動くし、実用上は問題ないだろうが、どうも気分的にやりたくない。
</p>

<p>
PR-400MIは、一体型のように思えるが、実は、モデム部分とルーター部分が内部で独立しており、モデムとルーターの間を、Ethernetでつなげるようになっている。モデム部分から、UNIと書かれたLANポートがでており、ルーターからのLANケーブルが刺さっている。すると、このUNI LANポートにRTX810をつなげば、完全にISPレンタルルーターを介さずにインターネットにつなげるではないか。
</p>

<p>
問題は、PR-400MIも、必要だということだ。住人の中に、FAXのために光電話を必要とする者がいるので、光電話は必要である。光電話を使うには、PR-400MIか、光電話をサポートしたルーターが必要である。RTX810は、光電話を使うような用途には想定されていないので、当然、光電話機能はない。すると、PR-400MIもUNIポートに接続しなければならない。
</p>

<p>
すると、気分的にあまりよろしくないが、やはりPR-400MI経由のPPPoEブリッジで我慢するしかないのだろうか。
</p>

<p>
Twitter上で、UNIをスイッチングハブで分けて、PR-400MIとRTX810のWANを接続すればいいではないかという助言をもらった。それだ。スイッチングハブでUNIを分けるという単純な発想に、なぜ思い至らなかったのか。
</p>

<p>
そうして、昨日一日作業して、妖怪ハウスのネットワークをRTX810に移行させた。
</p>

<p>

</p>

<p>
それにしても気になるのは、スイッチングハブはどうやってUNIとPR-400MIとRTX810をさばいているのだろうかということだ。このスイッチングハブの利用には、ルーターは一切絡んでいないような気がする。3本の接続は、スイッチングハブからは、どれも平等に見えているのではなかろうか。RTX810の発したパケットは、PR-400MIではなくUNIに届いて欲しいのだが、どうやって動いているのだろうか。スイッチングハブからどうやって見分けているのだろうか。
</p>

<p>
ネットワーク周りも基礎から真面目に学ばなければならない。
</p>

<p>
そして、RTX810をDNSキャッシュサーバーとして動作させると、nslookupは使えるのだが、digが使えなくなる。
</p>

<pre><code>dig example.com</code></pre>

<p>
が動かない。DNSサーバーのアドレスは、127.0.1.1であるので、digで指定してみたが、やはり通らない。
</p>

<pre><code>dig @8.8.8.8 example.com</code></pre>

<p>
は通る（8.8.8.8はGoogleが提供しているDNSサーバー）
</p>

<p>
nslookupは使えるし、その他のDNS lookupは問題ないようだ。digがなにか特殊なことをしているのであろうか。RTX810に何らかの設定項目があるのだろうか。
</p>

<p>
こうして、妖怪ネットワークは快適になった。
</p>

<p>
しかし、既存の妖怪ハウスの住人が、どうやって貧弱で不安定なネットワークで暮らせていたのか謎だ。筆者がまともなネットワークを構築するまでは、妖怪ネットワークは極めて不安定で遅延もひどかったのだ。（というより、ほとんどの問題は、RTX810導入以前にまともなスイッチングハブをひとつ導入するだけで解決されてしまった）
</p>

<p>
改善前の妖怪ネットワークは、一度TCPコネクションをはれば、切れることはないものの、それ以外は極めて不安定だった。
</p>

<p>
詳しく調べていないのでよくわからないが、たとえば、帯域には波があった。実験のために、十分な帯域を持ったインターネット上のサーバーからダウンロードを行ってみると、数秒100Mbpsを超えたと思えば、数秒間何の転送も行われないような、極端な帯域の波があった。わざわざ、誰も帯域を使っていなさそうな時間帯に試験したのにこれだ。また、ブラウザーで新しいページを開くときに、何十秒も待たされることがたびたびあった。DNS lookupが遅いのか、TCPコネクションを張るのが遅いのか、あるいは単に、先ほど観測された帯域の波という謎の現象のせいなのか、よくわからない。
</p>

<p>
また、リビングに設置されている無線LAN機器もひどかった。BUFFALO製の機器で、最高54Mbpsでしかリンクできなかった。おそらくはIEEE 802.11nに対応していない機器なのだろう。それだけならまだ許せるが、なぜか数Mbps程度のリンク速度しかでない場合がほとんどだった。どんなに適切な場所を探しても、一向にまともなリンク速度がでない。しかも通信も不安定だった。そんなよくわからない無線LANルーター（APモードで動作）をハブ代わりにして、すべてのLANポートにケーブルが刺さっていた。
</p>

<p>
筆者のネットの利用方法として、ブラウザーでブックマークしたURLを数十個一気に開いては確認して閉じるようなことをしているので、妖怪ハウスのネットワークの不安定さは耐えられないほどであった。
</p>

<p>
さて、今回、私が使う部分のネットワークは、私が金を出してまともにした。私が使わない部分に関しては、そのままにしてある。ただし、ネットワーク全体がまともになったので、私の使わない部分も恩恵は受けているが、現時点では、私の使わないところの大部分は完全に潜在的な性能を引き出していない。私の責任ではない。理由は後述。
</p>

<p>
妖怪ハウスにおいて、筆者はリビングの横の部屋に住んでいるのだが、住人の過半数は、リビングからは離れた部屋群に住んでいる。この部屋群に向かって伸びているLANケーブルがささったスイッチングハブのLEDを確認すると、なんと100Mbpsでしかリンクしていなかった。しかも、LANケーブルの先は安物のBUFFALOの無線LANルーター（APモード）につながっていて、もちろんこの無線LANも、IEEE 802.11nに対応していないため、リンク速度は最大54Mbps。ほとんどの住人はその無線経由でネットワークにつながっている。一人だけ、無線LANルーターをハブ代わりにして有線を部屋に引き込んでいる。
</p>

<p>
この部屋群のネットワークは、物理的に観測しても悲惨である。LANケーブルが無造作に床をはっているし、無線LANルーターも、固定されずに床に落ちている。以前は床にテープで固定していたらしいが、剥がれたらしい。当然だ、床に固定するから蹴り飛ばされるのだ。
</p>

<p>
あまりにみかねたので、配線だけはすこし直した。LANケーブルを壁にはわせるようにし、無線LANルーターも壁に固定した。
</p>

<p>
その際に調査を行ったところ、LANケーブルは1Gbpsのリンク速度がでた。すると、100Mbpsのリンク速度しかでないのは、このBUFFALOの機器のせいだろう。
</p>

<p>
これをまともにするには、8ポート（あるいは部屋ごとにさらにスイッチングハブで分けるのならば4ポートでも可）ぐらいのまともなスイッチングハブと、まともな無線LAN APに取り替えればよい。そうすれば、各部屋に有線LANとまともな無線LANが行き渡る。筆者はこの部屋群は使わないので、さすがにそこに金を出すことはしない。
</p>

<p>
結局、インターネット回線はフレッツ光なので、帯域は下り200Mbps/上がり100Mbpsだ。したがって、100Mbpsでも、それほどの問題はないと思うかも知れない。しかし、それはあくまでインターネット回線との間の帯域だ。妖怪ネットワーク内には、もっと広帯域が必要なのだ。妖怪ハウスでは、SMBプロトコルによるファイル共有を行っている住人が多い。当然だ。リビングまでストレージを担いでやってきて作業したい者などいるわけがない。そして、住人の大半は部屋群に集中している。この構成では、部屋群の誰かがSMBプロトコルで自分のストレージに本気でアクセスしただけで、部屋群全体のネットワーク帯域がほとんど使い尽くされてしまうはずだ。なぜならば、部屋群は全体で100Mbpsしか帯域がないからだ。
</p>

<p>
ただ、部屋群の住人は、以前の悲惨なネットワークでも、改善するほどの不満はなかったのだから、それほど帯域を使っていないのかも知れない。実際に聞けば、最近はファイル共有を使っていないという。
</p>

<p>
ともかく、妖怪ネットワークは快適になった。
</p>

</article>

<footer>
<p>
Unless otherwise noted,<br>
<br>
Copyright (C) 2014 江添亮<br>
<br>
Permission is granted to copy, distribute and/or modify this document under the terms of the GNU Free Documentation License, Version 1.3 or any later version published by the Free Software Foundation; with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
</p>
</footer>
</body>
</html>
