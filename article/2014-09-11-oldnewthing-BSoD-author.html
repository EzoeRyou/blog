<!doctype html>
<html>
<head>

<title>
本の虫: Old New Thing: ブルースクリーンを書いた人間は、まあ、僕さ。
</title>


<link rel="stylesheet" type="text/css" href="../css/default.css" ></link>

<style type="text/css">
</style>

<!-- highlight.js -->
<link rel="stylesheet" type="text/css" href="../css/github.css"></link>
<script type="text/javascript" src="../js/highlight.pack.js"></script>
<script type="text/javascript">hljs.initHighlightingOnLoad();</script>

<!-- mathjax CDN -->
<script type="text/javascript"
  src="https//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


</head>

<body>

<header>
<h1><a href="http://cpplover.blogspot.jp/">本の虫</a></h1>

<p>
著者：江添亮<br>
ブログ: <a href="http://cpplover.blogspot.jp/">http://cpplover.blogspot.jp/</a><br>
メール: boostcpp@gmail.com<br>
Twitter: <a href="https://twitter.com/EzoeRyou">https://twitter.com/EzoeRyou</a><br>
GitHub: <a href="https://github.com/EzoeRyou">https://github.com/EzoeRyou</a>
</p>
<p>
<a href="http://www.amazon.co.jp/registry/wishlist/1X43J4K0NJVHK">アマゾンの江添のほしい物リスト</a>を著者に送るとブログ記事のネタになる
</p>

<p>
筆者にブログのネタになる品物を直接送りたい場合、住所をメールで質問してください。
</p>
</header>


<article>
<h1><a href="http://cpplover.blogspot.jp/2014/09/old-new-thing.html">Old New Thing: ブルースクリーンを書いた人間は、まあ、僕さ</a></h1>

<p>
Old New Thingの著者で、古参MS社員のRaymond Chenが、Windows 95のブルースクリーンを書いた時のことをブログに書いている。
</p>

<blockquote>
<p>
<a href="http://blogs.msdn.com/b/oldnewthing/archive/2014/09/10/10556421.aspx">I wrote the original blue screen of death, sort of - The Old New Thing - Site Home - MSDN Blogs</a>
</p>

<p>
この前、Windows 95の<a href="http://blogs.msdn.com/b/oldnewthing/archive/2014/09/09/10556049.aspx">話を持ちだした</a>。ここで書いたように、Ctrl + Alt + Delダイアログは、Windows 3.1で導入され、Windows 95では、すでになくなった。Windows 95では、Ctrl + Alt + Delを押すと、以下のようなダイアログボックスが表示される。
</p>

<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0
       STYLE="color: black; background-color: #d4d0c8;
              border-width: 2px; border-style: outset;
              font-size: 9pt; width: 0em; hyphens: none;
              font-family: MS Sans Serif, Arial, sans-serif">
<TR BGCOLOR="#0a246a"
           STYLE="padding: 2px; font-size: 8pt;
           font-family: Tahoma, MS Sans Serif, Arial, sans-serif">
  <TD ALIGN=right STYLE="padding: 4px 2px 4px 4px">
    <B STYLE="float: left; color: white">Close Program</B>
    <SPAN STYLE="background-color: #d4d0c8; border: solid 1px white; border-bottom-color: #404040; border-right-color: #404040">
      <SPAN STYLE="border: solid 1px transparent; border-right-color: #808080; border-bottom-color: #808080; position: relative">
        <FONT STYLE="position: relative; top: -1px; left: 1px"><B>&times;&nbsp;</B></FONT>
      </SPAN>
    </SPAN>
  </TD>
</TR>
<TR>
  <TD STYLE="padding: 10px; padding-bottom: 0px">
    <DIV STYLE="background: white; height: 15em; padding-bottom: 2px;
                border: 2px inset #d4d0c8">
     <DIV STYLE="border: 0px dotted white">
     Explorer</DIV>
     <DIV STYLE="border: 1px dotted white; background: #000080; color: white">
     Contoso Deluxe Composer [not responding]</DIV>
     <DIV STYLE="border: 0px dotted white">
     Fabrikam Chart 2.0</DIV>
     <DIV STYLE="border: 0px dotted white">
     LitWare Chess Challenger</DIV>
     <DIV STYLE="border: 0px dotted white">
     Systray</DIV>
    </DIV>
    <DIV>
    WARNING: Pressing CTRL+ALT+DEL again will restart your computer.
    You will lose unsaved information in all programs that are running.
    </DIV>
  </TD>
</TR>
<TR>
  <TD NOWRAP STYLE="padding: 10px" ALIGN=center>
    <DIV STYLE="border: solid 1px black; margin: 2px; display: inline-block">
     <DIV STYLE="border: solid 1px; border-color: white black black white">
      <DIV STYLE="border: solid 1px; border-color: #C0C0C0 #808080 #808080 #C0C0C0">
       <DIV STYLE="border: 1px dotted black; width: 8em">
        <U>E</U>nd Task
       </DIV>
      </DIV>
     </DIV>
    </DIV>
    <DIV STYLE="border: solid 1px; border-color: white black black white; margin: 2px; display: inline-block">
     <DIV STYLE="border: solid 1px; border-color: #C0C0C0 #808080 #808080 #C0C0C0">
      <DIV STYLE="border: solid 1px transparent">
       <DIV STYLE="border: 0px dotted black; width: 8em">
        <U>S</U>hut Down
       </DIV>
      </DIV>
     </DIV>
    </DIV>
    <DIV STYLE="border: solid 1px; border-color: white black black white; margin: 2px; display: inline-block">
     <DIV STYLE="border: solid 1px; border-color: #C0C0C0 #808080 #808080 #C0C0C0">
      <DIV STYLE="border: solid 1px transparent">
       <DIV STYLE="border: 0px dotted black; width: 8em">
        Cancel
       </DIV>
      </DIV>
     </DIV>
    </DIV>
  </TD>
</TR>
</TABLE>

<p>
(Systrayについては<a href="http://blogs.msdn.com/b/oldnewthing/archive/2003/09/10/54831.aspx">以前学んだよね</a>)
</p>

<p>
Windows 3.1では、深刻なエラーではクラッシュしてブラックスクリーンになったが、Windows 95では、青で表示するようにした。僕はそのコードを書いたうちの一人だ。少なくとも、最後に書き換えた人間だな。
</p>

<p>
私はブルースクリーンメッセージを表示するコードを担当していた。カーネルモードビデオドライバーにテキストモードに切り替えるよう指示し、画面を青背景にして、白文字を表示して、ユーザーがキー入力をするのを待ち、画面を元に戻し、ユーザーの入力を、メッセージを表示するよう要請したコンポーネントに伝える[1]。
</p>

<p>
デバイスドライバーがクラッシュした場合、Windows 95はカーネルモードコンポーネント内の深刻な問題に、最善を尽くして対処しようとする。死の青画面(blue screen of death)というべきなのか、怠惰の青画面(blue screen of lameness)というべきなのか。ブルースクリーンを見たことがない幸運なもののために、以下がその例だ。
</p>

<TABLE STYLE="font-size: 80%; background-color: #00F; color: white; font-family: Consolas, monospace; font-weight: bold; hyphens: none">
<TR>
    <TD STYLE="width: 80ex; padding: 5ex">
    <BR><BR>
    <DIV STYLE="text-align: center"><SPAN STYLE="background-color: #888; color: #0000FF">&nbsp;Windows&nbsp;</SPAN></DIV>
    <DIV><BR><BR></DIV>
    <DIV>An exception 0D has occurred at 0028:80014812.
This was called from 0028:80014C34.
It may be possible to continue normally.
</DIV>
    <DIV><BR></DIV>
    <DIV>* Press any key to attempt to continue.</DIV>
    <DIV>* Press CTRL+ALT+DEL to restart your computer. You will</DIV>
    <DIV>&nbsp; lose any unsaved information in all applications.</DIV>
    </DIV>
    </TD>
</TR>
</TABLE>

<p>
「通常通り動作を実行できるかもしれませんよ」という楽観的な文面に注目されたい。みんな忘れているが、Windows 95は、ブルースクリーンエラーを表示した後、なるべくそのエラーを無視して実行し続けようとすることだ。つまり、まあ、スキャナーのドライバーはクラッシュしたので、スキャナーは動かなくなったかもしれないけれど、それ以外のシステムは無事だというわけだ。
</p>

<p>
(これを今日おこなったらどうなるだろうか。「カーネルパニックを無視するには何かのキーを押してください」)
</p>

<p>
技術的に何が行われているかというと、バーチャルマシンマネージャーが現在行われているイベントを破棄して、イベントディスパッチャーに戻るのだ。これは、カーネル内における、<a href="http://blog.paulbetts.org/index.php/2010/07/20/the-case-of-the-disappearing-onload-exception-user-mode-callback-exceptions-in-x64/">例外をウインドウプロシージャで飲み込ん</a>で、メッセージループに戻るようなものだ。継続できるイベントがなければ、現在のアプリケーションが終了される。
</p>

<p>
時に、問題はシステム全体に及ぶこともあり、現在のイベントを破棄したり、アプリケーションを終了しても、問題を解決しないことがある。次に起こるのは、次のイベントやアプリケーションが、同じ問題に引っかかり、数ミリ秒後に、またブルースクリーンメッセージを目にするということだ。何回か似たようなメッセージを目にした後、おそらくは諦めて、Ctrl + Alt + Delを押すだろう。
</p>

<p>
さて、当初のメッセージは、上のようであった。しかし、メッセージには問題上がる。デバイスドライバーがカーネルに読み込まれるアドレスというのは予測可能ではないので、生のアドレスが表示されていても、大して役に立たない。もし誰かが、「うちんとこの重役がこんなクラッシュメッセージ出したんだけど、何があったか分かるかい？」と言われたとしても、得られるのは無意味な数値だけだ。
</p>

<p>
その誰かというのは、僕でもあったわけだ。
</p>

<p>
この問題に対処しやすくするために、僕はメッセージを書き開けて、ドライバーの名前と、セクション番号と、セクションからのオフセットを追加した。
</p>

<TABLE STYLE="font-size: 80%; background-color: #00F; color: white; font-family: Consolas, monospace; font-weight: bold; hyphens: none">
<TR>
    <TD STYLE="width: 80ex; padding: 5ex">
    <BR><BR>
    <DIV STYLE="text-align: center"><SPAN STYLE="background-color: #888; color: #0000FF">&nbsp;Windows&nbsp;</SPAN></DIV>
    <DIV><BR><BR></DIV>
    <DIV>An exception 0D has occurred at 0028:80014812 in
VxD <NOBR>CONTOSO(03)</NOBR> + 00000152.
This was called from 0028:80014C34 in VxD
<NOBR>CONTOSO(03)</NOBR> + 00000574.
It may be possible to continue normally.
</DIV>
    <DIV><BR></DIV>
    <DIV>* Press any key to attempt to continue.</DIV>
    <DIV>* Press CTRL+ALT+DEL to restart your computer. You will</DIV>
    <DIV>&nbsp; lose any unsaved information in all applications.</DIV>
    </DIV>
    </TD>
</TR>
</TABLE>

<p>
これで、クラッシュしたドライバーの名前が分かる。何もわからなかったとしても、問題がどこにあるかのヒントは得られるわけだ。ドライバーのMAPファイルにアクセスした誰かさんは、アドレスを探して、クラッシュした箇所を特定できる。最高ではないにせよ、何もないよりマシだ。僕がこの変更をするまでは、何もなかったのだ。
</p>

<p>
そういうわけで、僕は<del>死</del>怠惰なブルースクリーンを、僕の仕事を多少マシにするために書き換えたと言える。
</p>

<p>
余話：その後、誰か（僕だったかどうかは覚えていないので、誰か同僚としておこう）が、クラッシュアドレスを調べるためのコードを追加した。もし、箇所がカーネルのヒープマネージャー出会ったアバイ、メッセージは多少変更される。
</p>

<TABLE STYLE="font-size: 80%; background-color: #00F; color: white; font-family: Consolas, monospace; font-weight: bold; hyphens: none">
<TR>
    <TD STYLE="width: 80ex; padding: 5ex">
    <BR><BR>
    <DIV STYLE="text-align: center"><SPAN STYLE="background-color: #888; color: #0000FF">&nbsp;Windows&nbsp;</SPAN></DIV>
    <DIV><BR><BR></DIV>
    <DIV>A 32-bit device driver has corrupted critical system memory,
    resulting in an exception 0D at 0028:80001812 in
VxD <NOBR>VMM(01)</NOBR> + 00001812.
This was called from 0028:80014C34 in VxD
<NOBR>CONTOSO(03)</NOBR> + 00000575.
</DIV>
    <DIV><BR></DIV>
    <DIV>* Press any key to attempt to continue.</DIV>
    <DIV>* Press CTRL+ALT+DEL to restart your computer. You will</DIV>
    <DIV>&nbsp; lose any unsaved information in all applications.</DIV>
    </DIV>
    </TD>
</TR>
</TABLE>

<p>
この場合、「通常通り動作を実行できるかもしれませんよ」という文面が消える。なぜなら、この場合、そういうことはまずないからだ。
</p>

<p>
余話：よくやったな。<a href="http://beta.slashdot.org/submission/3832559/raymond-chen-authored-the-windows-31-ctrlaltdel-screen">Slashdot</a>君。訂正をしたつもりかもしれないが、その訂正も間違っているよ。まあ、間違いには気がついたみたいだけどね。
</p>

<p>
[1]: このコードはカーネルで動くので、キーボードレイアウト情報にはアクセスできない。読者がChinese-Bopomofoキーボードレイアウトを使っているかどうかなんてわかりっこない。その場合、"OK"とタイプするには、C, L, 3だ。特に訳には立たないけどね。カーネルにはIMEなんてないんだから。そういうわけで、入力は、EnterとかESCみたいな、言語からは独立したキーに割り当てられていた。
</p>
</blockquote>

<p>
だいぶ久しぶりにOld New Thingを訳した気がする。以前はだいぶ苦労していた翻訳も、今はそれほど苦労しないのは、英語力が上がったからであろうか。それとも単に慣れたのか。
</p>

</article>

<footer>
<p>
Unless otherwise noted,<br>
<br>
Copyright (C) 2014 江添亮<br>
<br>
Permission is granted to copy, distribute and/or modify this document under the terms of the GNU Free Documentation License, Version 1.3 or any later version published by the Free Software Foundation; with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
</p>
</footer>
</body>
</html>
