<!doctype html>
<html>
<head>

<title>
本の虫: 妖怪ハウスのネット環境改善作業 
</title>


<link rel="stylesheet" type="text/css" href="../css/default.css" ></link>

<style type="text/css">
</style>

<!-- highlight.js -->
<link rel="stylesheet" type="text/css" href="../css/github.css"></link>
<script type="text/javascript" src="../js/highlight.pack.js"></script>
<script type="text/javascript">hljs.initHighlightingOnLoad();</script>

<!-- mathjax CDN -->
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


</head>

<body>

<header>
<h1><a href="http://cpplover.blogspot.jp/">本の虫</a></h1>

<p>
著者：江添亮<br>
ブログ: <a href="http://cpplover.blogspot.jp/">http://cpplover.blogspot.jp/</a><br>
メール: boostcpp@gmail.com<br>
Twitter: <a href="https://twitter.com/EzoeRyou">https://twitter.com/EzoeRyou</a><br>
GitHub: <a href="https://github.com/EzoeRyou">https://github.com/EzoeRyou</a>
</p>
<p>
<a href="http://www.amazon.co.jp/registry/wishlist/1X43J4K0NJVHK">アマゾンの江添のほしい物リ妖怪ハウスのネット環境改善作業スト</a>を著者に送るとブログ記事のネタになる
</p>
</header>


<article>
<h1><a href="http://cpplover.blogspot.jp/2014/03/blog-post.html"> 妖怪ハウスのネット環境改善作業</a></h1>

<p>
筆者が妖怪ハウスにやってきたとき、妖怪ハウスのネット環境は悲惨だった。
</p>

<p>
まず、ISP提供のモデム兼ルーターと、無線LANルーターが床に落ちている。配線も他の様々なコードとからみあって、わけがわからない状態であった。5LDKの家でLANケーブルが床を無造作にはっている。
</p>

<p>
そして、無線LANルーターが貧弱すぎて遅かったし、すぐに途切れた。有線でもやはり遅かったし、時々動かなくなることが会った。
</p>

<p>
住人の話では、「夜に特に遅くなる。0.01Mbpsしかでないときもある。誰かがP2P型のファイル共有かなにかで帯域を使っているのだろうか」ということであった。
</p>

<p>
そもそも、ISPとの契約書すらなくしていた。一体、回線がどういう契約なのかすらわからない。VDSLだろうか。光ファイバーが来ているのだろうか。それを調べようにも、機器が床に落ちて、複雑に絡み合ったコードの中に埋まり、確認ができなかった。
</p>

<p>
色々と調べた結果、回線はフレッツ光だった。いくら住人と客人で使うからと言って、200Mbpsもあれば十分なはずだ。なぜこんなに遅いのか。
</p>

<p>
その帯域というのも、それほど狭くはない。試してみれば、100Mbps以上は余裕で出る。問題は、帯域は広いのだが、なぜか帯域を観測すると波がある。数秒100Mbps以上でて、数秒落ち込むというサイクルを繰り返している。
</p>

<p>
それに、この家の住人で、P2P型ファイル共有ソフトウェアを使えるだけの十分な知識を持っていそうな人間は数人しかいない。プライベートネットワーク内におけるファイル共有はかなり発見できるが、これは、不自由なWindowsや不自由なMac OS Xがデフォルトで設定しているものにすぎない。それに、これは1Gbpsのプライベートネットワーク内で完結しているものであり、インターネット上には出て行かない。
</p>

<p>
まてよ・・・ひょっとしてルーターのせいなのだろうか。考えてみれば、ISP提供のルーターは、このようなシェアハウスの環境を想定していない。何人も住んでいて、客人も来て、それぞれに数台はコンピューターを使っていることを考えれば、ISP提供の非力なルーターが耐えられるわけがない。
</p>

<p>
それにしても、なぜこんな環境で、住人は暮らせているのだろうか。インターネットは、もはや水や電気と同じく、基本的人権に加えられるべきインフラだ。こんなに貧弱なネット環境はありえない。
</p>

<p>
仕方がないので、筆者自ら、妖怪ハウスのネット環境を強力に作り変えることにした。ルーターが確認できないほどこんがらがった電源ケーブル、LANケーブルを整理し、各部屋に送るLANケーブルも壁に固定しなければならない。また強力なネットワーク機器が必要だ。
</p>

<p>
筆者は秋葉原に行き、様々な機器を購入した。だいぶ痛い出費だったが、仕方がない。
</p>

<p>
まず、電源ケーブルを整理した。複数の電源タップに、テレビやルーター機器などの抜いてはいけないコンセントと、抜いてもいいACアダプターなどが、乱雑にささって、ゴルディアスの結び目よろしく、複雑に絡み合っている。残念ながら、ここではかの大王が取ったような画期的な手法を取ることはできない。一つ一つ結び目を解いていかなければならないのだ。
</p>

<p>
そもそも、なぜISPレンタルルーターと、無線LANルーターが、床に落ちて電源ケーブル類と絡まっているかというと、Ethernetポートのためだ。ISPレンタルモデムと無線LANルーターのポートすべてに、LANケーブルが刺さっている。元は本棚の上に設置していたそうだが、ケーブルに引っ張られて床に落ちたまま、放置されていたのだ。
</p>

<p>
Ethernetポートが足りないから、こういうことが起こるのだ。ポートがルーターにしかないから、そこに刺してしまうのだ。この問題を解決するためには、ポート数の多いスイッチングハブを使い、ルーターからケーブルを取り除く必要がある。たまたま、同居人が5ポートほどあるBUFFALOのハブを持っていたが、これをネットワークに接続すると、なぜか家中のネットワーク全体が不安定になる。壊れているのだろうか。
</p>

<p>
秋葉原で色々と探した挙句、筆者は<a href="http://www.amazon.co.jp/gp/product/B002T0ISNU/ref=as_li_ss_tl?ie=UTF8&camp=247&creative=7399&creativeASIN=B002T0ISNU&linkCode=as2&tag=boostcpp-22">NETGEAR GS116v2 16ポート ギガビットノンインテリジェントスイッチ (省電力製品) GS116-200JPS (本体ライフタイム保証)</a><img src="http://ir-jp.amazon-adsystem.com/e/ir?t=boostcpp-22&l=as2&o=9&a=B002T0ISNU" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />と
<a href="http://www.amazon.co.jp/gp/product/B00DC4KTZW/ref=as_li_ss_tl?ie=UTF8&camp=247&creative=7399&creativeASIN=B00DC4KTZW&linkCode=as2&tag=boostcpp-22">日本電気 AtermWG600HP PA-WG600HP</a><img src="http://ir-jp.amazon-adsystem.com/e/ir?t=boostcpp-22&l=as2&o=9&a=B00DC4KTZW" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />を買った。
</p>

<p>
特に選択に意味はない。BUFFALOという安かろう悪かろうの粗悪な製品を避けたかったからだ。
</p>

<p>
<iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=boostcpp-22&o=9&p=8&l=as4&m=amazon&f=ifr&ref=ss_til&asins=B002T0ISNU" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>

<iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=boostcpp-22&o=9&p=8&l=as4&m=amazon&f=ifr&ref=ss_til&asins=B00DC4KTZW" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
</p>

<p>
さて、もともと、ルーターからLANケーブルを排除する目的で、Netgearの16ポートのスイッチングハブを導入し、ISPレンタルルーターへの接続を一本にしたところ、なんと、ネットワークの不安定さが、だいぶ解消されてしまった。なるほど、ISPレンタルの貧弱ルーターのEthernetポートをすべて埋めると、負荷がかかりすぎてしまうのかもしれない。それにしても、スイッチングハブというのは、実は意外と高度なことをしているのだな。いままで、スイッチングハブの存在を侮っていた。単にLANケーブルを分割する程度の認識しか持っていなかった。今回買った、このNetgearの製品は、ノンインテ入りジェントという名称が入っているが、どうやらこれは、同社の他の製品に比べればノンインテリジェントという意味らしい。さらに高価なスイッチングハブには、ハブ自体にQoS機能などがあり、ハブにログインして設定できるのだという。
</p>

<p>
さて、そして、今までの56Mbpsでしかリンクできない貧弱なBaffaloNECの無線LANルーターを、NECのルーターで置き換えた、このNECのルーターの設定UIはとてもクソで、初回ログインはクソみたいなわけのわからない、しかもまともに設定できずに使い物にならない、そもそもまともに設定して突破することもできない、自称簡単設定UIを表示し、しかもその設定を済ませなければ詳細な設定UIにアクセスできないとあって、非常に難渋した。幸い、このNECのクソUIのルーターに詳しい知人が、一度ログインしたまま、もう一度ログインすると、通常の詳細設定UIが表示されるという助言をもらったので、なんとか、この自称簡単設定UIを突破することができた。いったい何なのだ、このクソUIは。
</p>

<p>
しかも、詳細設定のUIも、設定の保存と設定の摘要が分かれているという、これまた訳のわからないクソUIだった。いったい、どこのバカがこんなクソUIを設計したのだ。
</p>

<p>
さて、NECのルーターのUIは、本当に本当にとてもとても排泄物だった。最初、設定のために、ルーターモードにしたNECのAtermとコンピューターをLANケーブルでつないで、ルーターにログインし、望みどおりに設定してからアクセスポイントモードにして、そのあとに妖怪ハウスのネットワークに接続した。すると、なぜか設定が反映されていない。いったいこれはどういうことだ。再びルーターモードに戻すが、やはり設定されている。APモードにすると設定されない。もしやこれは・・・
</p>

<p>
なんと、このNECのクソ無線LANルーターは、ルーターモードとAPモードで、設定が独立しているのであった。いったいどこのトチ狂ったバカが、どんな薬物を摂取したら、こんな設計になるのだ。根本的に腐っている。
</p>

<p>
さて、設定に関して、とても糞だったNECの無線LANルーターだが、とりあえず無線LANとしては、そこそこの仕事をしてくれた。ただし、いずれは業務用のいい無線LAN APを導入したい。
</p>

<p>
さて、Netgearのスイッチングハブと、NECの無線LANルーター（APモード）を導入したところ、妖怪ハウスのネット環境は、なんとかなりマシになってしまった。なるほど、スイッチングハブは侮れないのだな。そして、無線LANも、安物を使うべきではないのだな。
</p>

<p>
しかし、まだダメだ。まだ満足できない。まだ遅い。どうも、DNS検索が遅いように思う。このISPレンタルルーターがDNSキャッシュサーバーとして動いているようだが、遅すぎてキャッシュの役割を果たしていない。むしろ逆に遅くなっている。そして、TCPコネクションを張るのにも、やや時間がかかっているように思われる。やはり、根本的に、このISPレンタルルーターは非力なのだ。DNSサーバーはこちらで設定することもできるが、住人全てにその設定ができるわけではない。
</p>

<p>
やはりここは、強力なルーターを導入しなければならない。100台規模の機器を余裕でさばけるような強力なルーターがほしい。しかし、そのような強力なルーターはなかなかに高価だ。さてどうしよう。
</p>

<p>
なんと、そのルーターが無料で手に入った。なんとも親切な人が、余っているからと、新品同様の
<a href="http://www.amazon.co.jp/gp/product/B005TC9B7M/ref=as_li_ss_tl?ie=UTF8&camp=247&creative=7399&creativeASIN=B005TC9B7M&linkCode=as2&tag=boostcpp-22">YAMAHAのRTX810</a><img src="http://ir-jp.amazon-adsystem.com/e/ir?t=boostcpp-22&l=as2&o=9&a=B005TC9B7M" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />を送ってくれたのだ。RTX810だと。それはちょっとした中小企業に導入して会社内のネットワークをそれひとつでさばけるような強力なルーターではないのか。そんないいものを。
</p>

<p>
さて、どうやってこのルーターを導入すればいいのだろうか。ISPレンタルルーターをよく観察したところ、どうやら、モデムとルーターの一体型に思われたこの機器は、内部で二つに分かれているようだ。モデム部分からUNIという名称でEthernetポートがあり、そこにルーター部分からLANケーブルがつながっている。これを差し替えれば、ISPレンタルの貧弱ルーターを使わないということが可能だ。
</p>

<p>
ただし問題は、電話が使えなくなるということだ。ある住人は、仕事上、自宅にFAXを置かなければならないため、難しい問題だ。なぜFAXを必要とするかというと、旧態依然の保守的でクソみたいな裁判所が、いまだにFAXを使い続けるからだ。日本の裁判所は、FAXのような平文で送信する信頼できない通信方法ではなく、電子署名と暗号化による暗号理論的に適切な通信方法に、今すぐ移行しなければならない。すでに行政の多くは、移行している。裁判所がそれをしないのは甚だしい怠慢である。
</p>

<p>
さて、それはともかく、せっかくYAMAHAのRTX810があるのだから、試験的に導入を試みた。これが・・・なかなか難渋した。
</p>

<p>
RTX810は、HTTPサーバーとして機能して、ブラウザー上から操作する簡単なUIを提供している。このUIは、NECのクソUIよりは、いくらかマシであったが、やはり使いづらい。
</p>

<p>
RTX810は、telnet/ssh/シリアルポートから接続して、直接文字列でコマンドを送信することで、設定することもできる。ただし、これがあまりよろしくない。
</p>

<p>
まず、まともなシェルがない。そして、文字コードが忌々しきシフトJISである。しかも、勝手に行数を区切って--more--的な表示をする(ただし、シフトJISで日本語なので、よくわからない)
</p>

<p>
わざわざシフトJISロケールを生成して、ターミナルからシフトJISを扱うのも面倒だ。とりあえずteeコマンドでファイルに吐き出してみたが、ド素人丸出しである。iconvで変換すればいいのではないかとおもったが、どうやらiconvは入力をバッファしてしまうらしく、動かない。入力をバッファせずに文字コード変換を行うソフトウェアに、nkf -uがある。これでようやく、出力の意味がわかった。しかし、なぜ日本語なのだ。なぜシフトJISなのだ。YAMAHAの顧客は不自由なWindows利用者だけなのか。どんなに小規模なネットワークであっても、管理者がWindows利用者というのは考えられないのだが。
</p>

<p>
あとで知ったことだが、RTX810では、以下のコマンドを使うと、まともな出力になるということが判明した。これがデフォルトになっているべきである。
</p>

<pre><code>console character ascii
console columns 200
console lines infinity
</code></pre>

<p>
忘れずにsaveしておこう。
</p>


<p>
さて、設定は終わり、実際にISPレンタル機器のUNIに接続してみたが、どうも動かない。いや、厳密に言うと動く。ISPとのPPPoEは通り、もちろんインターネットにつながっているのだが、なぜかDNSの設定がうまくいっていないようだ。それも、DHCPでDNSサーバーのIPアドレスを通知するところがうまくいっていない。なぜだろうか。
</p>

<p>
この問題は、ついに、なぜ動かなかったのかわからなかった。何度か試行錯誤するうちに、いつのまにか動くようになった。おそらく、最初はadministratorコマンドをうち忘れていたのではないかと思う。
</p>

<p>
さて、RTX810の初期設定では、DHCPで割り当てるIPアドレスは、192.168.100.xとなっている。住人の中に、わかりにくいから192.168.1.xから割り当ててくれと言う人間がいたので、dhcp scopeを設定した。設定したところ、どうやら間違えてしまったようで、RTX810のDHCP機能が動かなくなってしまった。dhcp scopeの設定方法を、もう少し学ばなければならない。第一、ネットマスクなる用語の意味を、正確に把握していない。
</p>

<p>
DHCPが動かないだけなのだから、DHCPにたよらずに、自前でIPアドレスを主張すればよかったのだが、早急に復旧させる必要があるため、そこには思い至らなかった。
</p>

<p>
RTX810は、RS-232cポートを持っており、シリアルケーブルで接続することでログインすることもできる。あいにくと、私のラップトップに、そのような古典的なポートは存在しない。今や、シリアルポートといえばUSBやSATAのたぐいを言うのであって、RS-232cではない。住人の一人に、シリアルポートのついた昔のラップトップを所有している人がいたが、残念ながら、ケーブルがない。
</p>

<p>
しかたがないので、スイッチの同時押しで、RTX810を初期化した。
</p>

<p>
初期化後、再び一から設定を始めたが、もうすっかり慣れたと見えて、こんどは短時間で設定できた。
</p>

<p>
ただし、初期化したことは正解であった。RTX810を譲ってくれた人を疑うわけではないが、やはり念の為に、初期化をしておくべきだろう。
</p>

<p>
さて、RTX810を試験的に導入した結果だが、完全に世界が変わった。ネットワーク内の遅延が劇的に改善され、実に快適で強力なネット環境が構築された。いつか人を集めて、各人ごとに持てるだけのコンピューターを持ってきてもらい、妖怪ハウスネット環境のストレステストを行いたいものだ。ただし、それには、もっと強力な業務用の無線LAN APも必要となるだろう。
</p>

<p>
なるほど、ネットワークの構築作業というのは、意外と楽しい。ハードウェアや構成を変更すると、パフォーマンスが劇的に変わるというのは、とても楽しい。いままで、ネットワーク管理者というのは、つまらなそうな職業だと思っていたが、なかなかどうして、やりがいのある仕事だ。いままであまりよろしくなかったネットワークのパフォーマンスを大幅に向上させた時の快感はたまらないものがある。自宅で中小企業に入れるレベルの機器を使って、数十台規模のネットワークを構築できる経験ができるというのは恵まれているといえるだろう。
</p>

<p>
とりあえず、今はISP提供のレンタルルーターを使っている。住人にFAXを使う人がいる以上、難しい問題だ。ネットワークに負荷がかかると予想されるとき（客を大勢呼んだ時とか）に、RTX810に差し替えるつもりだ。ただし、いずれは、RTX810に置き換えたい。
</p>

<p>
電話の問題は、二回線引けばいいのだが、残念ながら、その住人にはそれほど金がない。ただし、裁判所がセキュリティ的にどうしようもないFAXを使い続ける以上、やはり専用の線をひくべきではあるのだが。いや、むしろまともな暗号理論の知識がない裁判所が変わるべきなのだ。裁判所、お前はクソだから改善しろ。数学的に証明された手法を否定して、平文で送る（しかも受け取り側の電話というのは、普通は人が張り付いておらず放置されているので、誰に読まれるかわからない）クソみたいなセキュリティがザルのFAXを、即刻廃止しろ。裁判所はクソだ。
</p>


<p>
妖怪ハウスの配線とネット環境は改善された。もうLANケーブルが床をはうことはない。もう貧弱な無線LANに悩まされることはない。トイレの中にまで無線LANが届くので、トイレにも作業用に電源タップを配置した。
</p>

<p>
まだ妖怪ハウスに改善すべきところは多々あるが、また後ほど、改善作業を終わらせてから記事を書く。
</p>

<p>
他にも欲しい、高価なネットワーク機器はある。またそれ以外にも欲しいものがある。レトロゲームのソフトや本体や周辺機器を揃えたい。これらは不自由なコンピューターではあるが、どうしても昔の思い出は捨てがたいのだ。現在、ファミコン、スーパーファミコン、ニンテンドー64、ゲームキューブ、PS2、PS3がある。ただし、PS2とPS3は新しすぎるのでレトロゲームの定義には当てはまらない。
</p>

<p>
もし、読者の中に、レトロゲームのソフトや周辺機器を妖怪ハウスに寄贈したい人がいれば、大歓迎だ。いつでもゲームをやりに遊びに来て欲しい。いまのところ、以下のものが欲しい。
</p>

<p>
ファミコン、スーパーファミコン、ニンテンドー64、ゲームキューブのソフト。クソゲーも歓迎する。スペランカーや元祖西遊記スーパーモンキー大冒険のような有名なクソゲーもある。また、ファミコンのディスクシステムもあるので、ディスクシステム用のソフトも欲しい。
</p>

<p>
スーパーファミコンのコントローラー（あと2本）とマルチタップ
</p>

<p>
ニンテンドー64のコントローラー（あと3本）、コントローラパック（いくつでも）
</p>

<p>
ゲームキューブのコントローラー（あと3本）、ゲームボーイプレイヤー（中古市場で手に入れるには、本体ごと購入する必要があり、高価）
</p>

<p>
ゲームボーイ、ゲームボーイポケット、ゲームボーイカラー、ゲームボーイアドバンスの本体と周辺機器とソフト（私が50分以内にRTAできるキャッスルヴァニア 〜暁月の円舞曲〜が特に欲しい。現在、中古市場価格が高止まりしていて、高価）
</p>

<p>
その他のレトロゲーム本体とソフト
</p>



</article>

<footer>
<p>
Unless otherwise noted,<br>
<br>
Copyright (C) 2014 江添亮<br>
<br>
Permission is granted to copy, distribute and/or modify this document under the terms of the GNU Free Documentation License, Version 1.3 or any later version published by the Free Software Foundation; with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
</p>
</footer>
</body>
</html>
